name: Pull Request Check

on:
  pull_request:
    branches:
      - main

jobs:
  build-and-validate:
    name: Build and Validate
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Build with Maven
      run: |
        mvn clean verify
        mvn clean install

    - name: Debug
      run: |
        ls -la ${{ github.workspace }}
        ls -la /home/runner

    - name: Build TCK image for AWS
      uses: docker/build-push-action@v6.17.0
      with:
        file: test/system-tests/generator-aws-terraform/Dockerfile.dockerfile
        tags: cloudhopper-tck-aws

    - name: Run TCK for AWS
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ vars.AWS_REGION }}
      uses: addnab/docker-run-action@v3
      with:
        image: cloudhopper-tck-aws:latest
        options: |
          -v ${{ github.workspace }}:/workspace
          -v /home/runner/.m2:/root/.m2
          -w /workspace
          -e AWS_ACCESS_KEY_ID
          -e AWS_SECRET_ACCESS_KEY
          -e AWS_REGION
        run: |
          echo 'üîç Recompiling only system tests...'
          mvn -f /workspace/pom.xml install -DskipTests -pl test/system-tests/generator-aws-terraform &&
          echo '‚ñ∂ Running TCK...'
          cd /workspace/test/system-tests/generator-aws-terraform/
          mvn exec:java \
            -Dexec.mainClass=eu.cloudhopper.mc.test.system.tests.generator.aws.terraform.TckLauncher \
            -Dexec.classpathScope=test

    - name: Build TCK image for GCP
      uses: docker/build-push-action@v6.17.0
      with:
        file: test/system-tests/generator-gcp-terraform/Dockerfile.dockerfile
        tags: cloudhopper-tck-gcp

    - name: Build TCK image for Azure
      uses: docker/build-push-action@v6.17.0
      with:
        file: test/system-tests/generator-azure-terraform/Dockerfile.dockerfile
        tags: cloudhopper-tck-azure

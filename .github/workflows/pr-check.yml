name: Pull Request Check

on:
  pull_request:
    branches:
      - main

jobs:
  build-and-validate:
    name: Build and Validate
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Build with Maven
      run: mvn clean verify

    - name: Build Docker image
      uses: docker/build-push-action@v6.17.0
      with:
        file: test/system-tests/generator-aws-terraform/Dockerfile.dockerfile
        tags: cloudhopper-tck-aws

    - name: Run TCK for AWS
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ vars.AWS_REGION }}
      uses: addnab/docker-run-action@v3
      with:
        image: cloudhopper-tck-aws:latest
        options: |
          -v ${PWD}:/workspace
          -v ~/.m2:/root/.m2
          -w /workspace
          -e AWS_ACCESS_KEY_ID
          -e AWS_SECRET_ACCESS_KEY
          -e AWS_REGION
        run: |
          echo '🔍 Recompiling only system tests...'
          mvn -f /workspace/pom.xml install -DskipTests -pl test/system-tests/generator-aws-terraform &&
          echo '▶ Running TCK...'
          cd /workspace/test/system-tests/generator-aws-terraform/
          mvn exec:java \
            -Dexec.mainClass=eu.cloudhopper.mc.test.system.tests.generator.aws.terraform.TckLauncher \
            -Dexec.classpathScope=test
          
    - name: Run TCK for GCP
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
      run: |
        echo $GOOGLE_APPLICATION_CREDENTIALS > ./credentials.json
        ./run-tck-gcp.sh --rebuild

    - name: Run TCK for Azure
      run: ./run-tck-azure.sh --rebuild
